using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Http;
using System.IO;
using Microsoft.AspNetCore.StaticFiles;
using ogloszenia.Models;
using ogloszenia.Services;
using ogloszenia.Data;
using Microsoft.EntityFrameworkCore;
using System.Linq;

namespace ogloszenia.Controllers
{
    public class AdvertisementController : Controller
    {
        private readonly ApplicationDbContext _context;

        public AdvertisementController(ApplicationDbContext context)
        {
            _context = context;
        }

        // GET: /Advertisement/Index
        public IActionResult Index(int page = 1, int pageSize = 10)
        {
            var ads = _context.Advertisements
                .Include(a => a.User)
                .Include(a => a.Categories)
                .Include(a => a.Media)
                .Where(a => a.Status == AdvertisementStatus.Active)
                .OrderByDescending(a => a.CreatedAt)
                .ToList();

            int totalPages = (int)Math.Ceiling(ads.Count / (double)pageSize);
            var pagedAds = ads
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = totalPages;
            ViewBag.PageSize = pageSize;

            return View(pagedAds);
        }

        // GET: /Advertisement/Details/5
        public IActionResult Details(int id)
        {
            var ad = _context.Advertisements
                .Include(a => a.User)
                .Include(a => a.Categories)
                .Include(a => a.Media)
                .Include(a => a.Files)
                .FirstOrDefault(a => a.Id == id);
            
            if (ad == null)
            {
                return NotFound();
            }

            // Increment view count
            ad.ViewCount++;
            _context.SaveChanges();

            return View(ad);
        }

        // GET: /Advertisement/Create
        public IActionResult Create()
        {
            ViewBag.Categories = _context.Categories.Where(c => c.ParentCategoryId == null).ToList();
            return View();
        }

        // POST: /Advertisement/Create
        [HttpPost]
        public IActionResult Create(Advertisement advertisement, int[] selectedCategories, IFormFile[]? mediaFiles, IFormFile[]? attachmentFiles)
        {
            if (!ModelState.IsValid)
            {
                ViewBag.Categories = _context.Categories.Where(c => c.ParentCategoryId == null).ToList();
                return View(advertisement);
            }

            // Get current user from session
            var userId = HttpContext.Session.GetInt32("UserId");
            if (userId == null)
            {
                return RedirectToAction("Login", "Account");
            }

            var user = _context.Users.FirstOrDefault(u => u.Id == userId.Value);
            if (user == null)
            {
                return RedirectToAction("Login", "Account");
            }

            advertisement.UserId = userId.Value;
            advertisement.CreatedAt = DateTime.Now;
            advertisement.Status = AdvertisementStatus.Active;
            advertisement.ViewCount = 0;
            {
                return RedirectToAction("Login", "Account");
            }

            advertisement.Id = InMemoryDatabase.GetNextAdvertisementId();
            advertisement.UserId = userId;
            advertisement.User = user;
            advertisement.CreatedAt = DateTime.Now;
            advertisement.Status = AdvertisementStatus.Active;
            advertisement.ViewCount = 0;

            // Add selected categories
            if (selectedCategories != null && selectedCategories.Length > 0)
            {
                foreach (var catId in selectedCategories)
                {
                    var category = _categories.FirstOrDefault(c => c.Id == catId);
                    if (category != null)
                    {
                        advertisement.Categories.Add(category);
                    }
                }
            }

            _advertisements.Add(advertisement);
            user.Advertisements.Add(advertisement);

            // Save uploaded media files to wwwroot/uploads/ads/{adId}
            try
            {
                var uploadsRoot = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "ads", advertisement.Id.ToString());
                Directory.CreateDirectory(uploadsRoot);

                if (mediaFiles != null && mediaFiles.Length > 0)
                {
                    foreach (var file in mediaFiles)
                    {
                        if (file != null && file.Length > 0)
                        {
                            var ext = Path.GetExtension(file.FileName);
                            var savedName = Guid.NewGuid().ToString() + ext;
                            var savePath = Path.Combine(uploadsRoot, savedName);
                            using (var stream = new FileStream(savePath, FileMode.Create))
                            {
                                file.CopyTo(stream);
                            }

                            var media = new AdvertisementMedia
                            {
                                Id = InMemoryDatabase.GetNextMediaId(),
                                AdvertisementId = advertisement.Id,
                                Advertisement = advertisement,
                                FileName = file.FileName,
                                FilePath = $"/uploads/ads/{advertisement.Id}/{savedName}",
                                MediaType = file.ContentType ?? "application/octet-stream",
                                UploadedAt = DateTime.Now
                            };
                            InMemoryDatabase.Media.Add(media);
                            advertisement.Media.Add(media);
                        }
                    }
                }

                if (attachmentFiles != null && attachmentFiles.Length > 0)
                {
                    foreach (var file in attachmentFiles)
                    {
                        if (file != null && file.Length > 0)
                        {
                            var ext = Path.GetExtension(file.FileName);
                            var savedName = Guid.NewGuid().ToString() + ext;
                            var savePath = Path.Combine(uploadsRoot, savedName);
                            using (var stream = new FileStream(savePath, FileMode.Create))
                            {
                                file.CopyTo(stream);
                            }

                            var attachment = new AdvertisementFile
                            {
                                Id = InMemoryDatabase.GetNextFileId(),
                                AdvertisementId = advertisement.Id,
                                Advertisement = advertisement,
                                FileName = file.FileName,
                                FilePath = $"/uploads/ads/{advertisement.Id}/{savedName}",
                                FileSize = file.Length,
                                UploadedAt = DateTime.Now
                            };
                            InMemoryDatabase.Files.Add(attachment);
                            advertisement.Files.Add(attachment);
                        }
                    }
                }
            }
            catch
            {
                // If saving files fails, continue without blocking creation (could log)
            }

            return RedirectToAction(nameof(Details), new { id = advertisement.Id });
        }

        // GET: /Advertisement/Edit/5
        public IActionResult Edit(int id)
        {
            var ad = _advertisements.FirstOrDefault(a => a.Id == id);
            if (ad == null)
            {
                return NotFound();
            }

            // For demo: allow editing for any user (userId hardcoded to 1 in actual edit/delete)
            // In production, check session-based userId
            // int userId = 1; // TODO: Get from session
            // if (ad.UserId != userId && !User.IsInRole("Admin"))
            // {
            //     return Forbid();
            // }

            ViewBag.Categories = _categories.Where(c => c.ParentCategoryId == null).ToList();
            ViewBag.SelectedCategoryIds = ad.Categories.Select(c => c.Id).ToArray();

            return View(ad);
        }

        // POST: /Advertisement/Edit/5
        [HttpPost]
        [ValidateAntiForgeryToken]
        public IActionResult Edit(int id, Advertisement advertisement, int[] selectedCategories, IFormFile[]? mediaFiles, IFormFile[]? attachmentFiles)
        {
            var ad = _advertisements.FirstOrDefault(a => a.Id == id);
            if (ad == null)
            {
                return NotFound();
            }

            int userId = 1; // TODO: Get from session
            if (ad.UserId != userId)
            {
                return Forbid();
            }

            if (!ModelState.IsValid)
            {
                ViewBag.Categories = _categories.Where(c => c.ParentCategoryId == null).ToList();
                ViewBag.SelectedCategoryIds = ad.Categories.Select(c => c.Id).ToArray();
                return View(ad);
            }

            ad.Title = advertisement.Title;
            ad.Description = advertisement.Description;
            ad.DetailedDescription = advertisement.DetailedDescription;
            ad.UpdatedAt = DateTime.Now;

            // Update categories
            ad.Categories.Clear();
            if (selectedCategories != null && selectedCategories.Length > 0)
            {
                foreach (var catId in selectedCategories)
                {
                    var category = _categories.FirstOrDefault(c => c.Id == catId);
                    if (category != null)
                    {
                        ad.Categories.Add(category);
                    }
                }
            }

            // Save new media files
            try
            {
                var uploadsRoot = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "ads", ad.Id.ToString());
                Directory.CreateDirectory(uploadsRoot);

                if (mediaFiles != null && mediaFiles.Length > 0)
                {
                    foreach (var file in mediaFiles)
                    {
                        if (file != null && file.Length > 0)
                        {
                            var ext = Path.GetExtension(file.FileName);
                            var savedName = Guid.NewGuid().ToString() + ext;
                            var savePath = Path.Combine(uploadsRoot, savedName);
                            using (var stream = new FileStream(savePath, FileMode.Create))
                            {
                                file.CopyTo(stream);
                            }

                            var media = new AdvertisementMedia
                            {
                                Id = InMemoryDatabase.GetNextMediaId(),
                                AdvertisementId = ad.Id,
                                Advertisement = ad,
                                FileName = file.FileName,
                                FilePath = $"/uploads/ads/{ad.Id}/{savedName}",
                                MediaType = file.ContentType ?? "application/octet-stream",
                                UploadedAt = DateTime.Now
                            };
                            InMemoryDatabase.Media.Add(media);
                            ad.Media.Add(media);
                        }
                    }
                }

                if (attachmentFiles != null && attachmentFiles.Length > 0)
                {
                    foreach (var file in attachmentFiles)
                    {
                        if (file != null && file.Length > 0)
                        {
                            var ext = Path.GetExtension(file.FileName);
                            var savedName = Guid.NewGuid().ToString() + ext;
                            var savePath = Path.Combine(uploadsRoot, savedName);
                            using (var stream = new FileStream(savePath, FileMode.Create))
                            {
                                file.CopyTo(stream);
                            }

                            var attachment = new AdvertisementFile
                            {
                                Id = InMemoryDatabase.GetNextFileId(),
                                AdvertisementId = ad.Id,
                                Advertisement = ad,
                                FileName = file.FileName,
                                FilePath = $"/uploads/ads/{ad.Id}/{savedName}",
                                FileSize = file.Length,
                                UploadedAt = DateTime.Now
                            };
                            InMemoryDatabase.Files.Add(attachment);
                            ad.Files.Add(attachment);
                        }
                    }
                }
            }
            catch
            {
                // If saving files fails, continue without blocking edit
            }

            return RedirectToAction(nameof(Details), new { id = ad.Id });
        }

        // GET: /Advertisement/Delete/5
        public IActionResult Delete(int id)
        {
            var ad = _advertisements.FirstOrDefault(a => a.Id == id);
            if (ad == null)
            {
                return NotFound();
            }

            int userId = 1; // TODO: Get from session
            if (ad.UserId != userId && !User.IsInRole("Admin"))
            {
                return Forbid();
            }

            return View(ad);
        }

        // POST: /Advertisement/Delete/5
        [HttpPost, ActionName("Delete")]
        [ValidateAntiForgeryToken]
        public IActionResult DeleteConfirmed(int id)
        {
            var ad = _advertisements.FirstOrDefault(a => a.Id == id);
            if (ad == null)
            {
                return NotFound();
            }

            int userId = 1; // TODO: Get from session
            if (ad.UserId != userId && !User.IsInRole("Admin"))
            {
                return Forbid();
            }

            _advertisements.Remove(ad);
            return RedirectToAction(nameof(Index));
        }

        // GET: /Advertisement/ByCategory/5
        public IActionResult ByCategory(int categoryId, int page = 1, int pageSize = 10)
        {
            var category = _categories.FirstOrDefault(c => c.Id == categoryId);
            if (category == null)
            {
                return NotFound();
            }

            var ads = _advertisements
                .Where(a => a.Status == AdvertisementStatus.Active && a.Categories.Any(c => c.Id == categoryId))
                .OrderByDescending(a => a.CreatedAt)
                .ToList();

            int totalPages = (int)Math.Ceiling(ads.Count / (double)pageSize);
            var pagedAds = ads
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = totalPages;
            ViewBag.PageSize = pageSize;
            ViewBag.Category = category;

            return View("Index", pagedAds);
        }

        // GET: /Advertisement/Search
        public IActionResult Search(string q = "", int page = 1, int pageSize = 10)
        {
            var query = q?.ToLower() ?? "";

            var ads = _advertisements
                .Where(a => a.Status == AdvertisementStatus.Active &&
                    (string.IsNullOrEmpty(query) || 
                     a.Title.ToLower().Contains(query) || 
                     a.Description.ToLower().Contains(query)))
                .OrderByDescending(a => a.CreatedAt)
                .ToList();

            int totalPages = (int)Math.Ceiling(ads.Count / (double)pageSize);
            var pagedAds = ads
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .ToList();

            ViewBag.CurrentPage = page;
            ViewBag.TotalPages = totalPages;
            ViewBag.PageSize = pageSize;
            ViewBag.SearchQuery = q;

            return View("Index", pagedAds);
        }

        // GET: /Advertisement/DownloadFile/5
        [HttpGet]
        public IActionResult DownloadFile(int fileId)
        {
            var file = InMemoryDatabase.Files.FirstOrDefault(f => f.Id == fileId);
            if (file == null)
            {
                return NotFound();
            }

            // Map virtual path (/uploads/...) to physical path
            var relative = file.FilePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar);
            var physicalPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", relative);
            if (!System.IO.File.Exists(physicalPath))
            {
                return NotFound();
            }

            var provider = new FileExtensionContentTypeProvider();
            if (!provider.TryGetContentType(physicalPath, out var contentType))
            {
                contentType = "application/octet-stream";
            }

            return PhysicalFile(physicalPath, contentType, file.FileName);
        }

        // POST: /Advertisement/DeleteMedia/{mediaId}
        [HttpPost("Advertisement/DeleteMedia/{mediaId}")]
        public IActionResult DeleteMedia(int mediaId)
        {
            var media = InMemoryDatabase.Media.FirstOrDefault(m => m.Id == mediaId);
            if (media == null)
            {
                return NotFound();
            }

            var ad = _advertisements.FirstOrDefault(a => a.Id == media.AdvertisementId);
            if (ad == null)
            {
                return NotFound();
            }

            // For now, allow deletion (userId=1 is hardcoded in Create/Edit)
            // TODO: Implement proper session-based userId check in production

            // Delete file from disk
            try
            {
                var relative = media.FilePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar);
                var physicalPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", relative);
                if (System.IO.File.Exists(physicalPath))
                {
                    System.IO.File.Delete(physicalPath);
                }
            }
            catch
            {
                // Log error but continue with removal from DB
            }

            // Remove from lists
            InMemoryDatabase.Media.Remove(media);
            ad.Media.Remove(media);

            return Ok(new { success = true });
        }

        // POST: /Advertisement/DeleteFile/{fileId}
        [HttpPost]
        public IActionResult DeleteFile(int fileId)
        {
            var file = InMemoryDatabase.Files.FirstOrDefault(f => f.Id == fileId);
            if (file == null)
            {
                return NotFound();
            }

            var ad = _advertisements.FirstOrDefault(a => a.Id == file.AdvertisementId);
            if (ad == null)
            {
                return NotFound();
            }

            // For now, allow deletion (userId=1 is hardcoded in Create/Edit)
            // TODO: Implement proper session-based userId check in production

            // Delete file from disk
            try
            {
                var relative = file.FilePath.TrimStart('/').Replace('/', Path.DirectorySeparatorChar);
                var physicalPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", relative);
                if (System.IO.File.Exists(physicalPath))
                {
                    System.IO.File.Delete(physicalPath);
                }
            }
            catch
            {
                // Log error but continue with removal from DB
            }

            // Remove from lists
            InMemoryDatabase.Files.Remove(file);
            ad.Files.Remove(file);

            return Ok(new { success = true });
        }
    }
}

